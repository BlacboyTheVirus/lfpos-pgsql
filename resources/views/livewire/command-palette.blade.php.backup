<div x-data="{
    isOpen: @entangle('isOpen'),
    search: @entangle('search'),
    selectedIndex: @entangle('selectedIndex'),

    init() {
        console.log('Command palette initialized');
        // Listen for open/close events
        Livewire.on('open-command-palette', () => {
            this.isOpen = true;
            this.$nextTick(() => {
                this.$refs.searchInput?.focus();
            });
        });

        Livewire.on('close-command-palette', () => {
            this.isOpen = false;
        });

        // Global keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Cmd/Ctrl + K to open
            if ((e.metaKey || e.ctrlKey) && e.key === 'k' && !this.isOpen) {
                e.preventDefault();
                @this.open();
            }

            // Escape to close
            if (e.key === 'Escape' && this.isOpen) {
                e.preventDefault();
                @this.close();
            }

            // Navigation when open
            if (this.isOpen) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    @this.incrementIndex();
                }
                if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    @this.decrementIndex();
                }
                if (e.key === 'Enter') {
                    e.preventDefault();
                    @this.selectItem();
                }
            }
        });

        // Close on backdrop click
        document.addEventListener('click', (e) => {
            if (this.isOpen && e.target === this.$el) {
                @this.close();
            }
        });
    }
}"
x-show="isOpen"
x-transition:enter="transition ease-out duration-200"
x-transition:enter-start="opacity-0"
x-transition:enter-end="opacity-100"
x-transition:leave="transition ease-in duration-150"
x-transition:leave-start="opacity-100"
x-transition:leave-end="opacity-0"
class="fixed inset-0 z-[9999] bg-black/20 backdrop-blur-sm"
@keydown.escape.window="if(isOpen) @this.close()">

    <!-- Modal Content -->
    <div class="fixed left-1/2 top-32 -translate-x-1/2 w-full max-w-2xl"
         x-show="isOpen"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 scale-95 translate-y-[-10px]"
         x-transition:enter-end="opacity-100 scale-100 translate-y-0"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100 scale-100 translate-y-0"
         x-transition:leave-end="opacity-0 scale-95 translate-y-[-10px]">

        <div class="mx-4 overflow-hidden rounded-lg bg-white shadow-2xl ring-1 ring-black/10 dark:bg-gray-900 dark:ring-white/10">

            <!-- Search Input -->
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>

                <input
                    x-ref="searchInput"
                    wire:model.live.debounce.100ms="search"
                    type="text"
                    placeholder="Jump to..."
                    class="block h-12 w-full pl-11 pr-4 text-sm bg-transparent placeholder-gray-500 focus:outline-none focus:ring-0"
                    autocomplete="off"
                >

                @if(!empty($search))
                    <div class="absolute inset-y-0 right-0 pr-4 flex items-center">
                        <button wire:click="set('search', '')" class="text-gray-400 hover:text-gray-600">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                @endif
            </div>

            <!-- Results -->
            <div class="max-h-96 overflow-y-auto">
                @if(empty($search) && !empty($recentItems))
                    <!-- Recent Items -->
                    <div class="px-2 py-2">
                        <div class="px-2 py-1 text-xs font-semibold text-gray-500 uppercase tracking-wider dark:text-gray-400">
                            Recent
                        </div>
                        @foreach(array_slice($recentItems, 0, 5) as $index => $item)
                            <button wire:click="selectItemByIndex({{ $index }})"
                                    @class([
                                        'w-full flex items-center gap-3 px-3 py-2 text-left rounded-md transition-colors',
                                        'bg-gray-100 dark:bg-gray-800' => $selectedIndex === $index,
                                        'hover:bg-gray-100 dark:hover:bg-gray-800' => $selectedIndex !== $index,
                                    ])>
                                @if($item['icon'])
                                    @svg($item['icon'], 'h-5 w-5 text-gray-400')
                                @endif
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate">
                                        {{ $item['title'] }}
                                    </div>
                                    @if(!empty($item['description']))
                                        <div class="text-sm text-gray-500 dark:text-gray-400 truncate">
                                            {{ $item['description'] }}
                                        </div>
                                    @endif
                                </div>
                            </button>
                        @endforeach
                    </div>
                @endif

                @if(!empty($filteredItems))
                    <!-- Navigation Items -->
                    @if(!empty($search) || (!empty($search) && empty($recentItems)))
                        <div class="px-2 py-2">
                            @if(empty($search) && !empty($recentItems))
                                <div class="px-2 py-1 text-xs font-semibold text-gray-500 uppercase tracking-wider dark:text-gray-400">
                                    Navigation
                                </div>
                            @endif
                            @foreach($filteredItems as $index => $item)
                                @php
                                    $displayIndex = !empty($search) && !empty($recentItems) ? $index + count(array_slice($recentItems, 0, 5)) : $index;
                                @endphp
                                <button wire:click="selectItemByIndex({{ $displayIndex }})"
                                        @class([
                                            'w-full flex items-center gap-3 px-3 py-2 text-left rounded-md transition-colors',
                                            'bg-gray-100 dark:bg-gray-800' => $selectedIndex === $displayIndex,
                                            'hover:bg-gray-100 dark:hover:bg-gray-800' => $selectedIndex !== $displayIndex,
                                        ])>
                                    @if($item['icon'])
                                        @svg($item['icon'], 'h-5 w-5 text-gray-400')
                                    @endif
                                    <div class="flex-1 min-w-0">
                                        <div class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate">
                                            {{ $item['title'] }}
                                        </div>
                                        @if(!empty($item['description']))
                                            <div class="text-sm text-gray-500 dark:text-gray-400 truncate">
                                                {{ $item['description'] }}
                                            </div>
                                        @endif
                                    </div>
                                </button>
                            @endforeach
                        </div>
                    @endif
                @elseif(!empty($search))
                    <!-- No Results -->
                    <div class="px-6 py-8 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-sm text-gray-900 dark:text-gray-100 font-medium">No results found</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Try searching for something else</p>
                    </div>
                @endif
            </div>

            <!-- Footer -->
            @if(empty($search))
                <div class="border-t border-gray-200 dark:border-gray-700 px-4 py-2 bg-gray-50 dark:bg-gray-800/50">
                    <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
                        <div class="flex items-center gap-4">
                            <kbd class="px-1.5 py-0.5 text-[10px] font-mono bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded">↑↓</kbd>
                            <span>Navigate</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <kbd class="px-1.5 py-0.5 text-[10px] font-mono bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded">↵</kbd>
                            <span>Select</span>
                            <kbd class="px-1.5 py-0.5 text-[10px] font-mono bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded">ESC</kbd>
                            <span>Close</span>
                        </div>
                    </div>
                </div>
            @endif
        </div>
    </div>
</div>